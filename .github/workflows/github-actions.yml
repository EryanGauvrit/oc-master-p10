name: GitHub Actions
on: [push]
jobs:
  back-quality:
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@v4
          with:
            fetch-depth: 0
        - name: Set up JDK 11
          uses: actions/setup-java@v4
          with:
            java-version: '11'
            distribution: 'temurin'
        - name: Cache SonarQube packages
          uses: actions/cache@v4
          with:
            path: ~/.sonar/cache
            key: ${{ runner.os }}-sonar
            restore-keys: ${{ runner.os }}-sonar
        - name: Cache Maven dependencies
          uses: actions/cache@v4
          with:
            path: ~/.m2/repository
            key: maven-${{ hashFiles('**/pom.xml') }}
            restore-keys: maven-
        - name: SonarQube Scan
          working-directory: ./back
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          run: mvn -B verify org.sonarsource.scanner.maven:sonar-maven-plugin:sonar -Dsonar.host.url=https://sonarcloud.io -Dsonar.organization=naoylcb -Dsonar.projectKey=naoylcb_Gerez-un-projet-collaboratif-en-int-grant-une-demarche-CI-CD

  docker:
    needs: [back-quality]
    runs-on: ubuntu-latest
    steps:
        - uses: actions/checkout@v4
        - name: Login to Docker Hub
          uses: docker/login-action@v3
          with:
            username: ${{ secrets.DOCKERHUB_USERNAME }}
            password: ${{ secrets.DOCKERHUB_TOKEN }}
        - name: Set up Docker Buildx
          uses: docker/setup-buildx-action@v3
        - name: Build and push front
          uses: docker/build-push-action@v6
          with:
            context: ./front
            push: true
            tags: yoanb/bobapp-front:latest
        - name: Build and push back
          uses: docker/build-push-action@v6
          with:
            context: ./back
            push: true
            tags: yoanb/bobapp-back:latest
