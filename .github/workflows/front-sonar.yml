name: SonarQube Analysis

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  sonarqube-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Set up SonarQube Scanner
        uses: sonarsource/sonar-scanner-cli@5.0
        env:
          SONAR_USER_HOME: ${{ github.workspace }}/.sonar
          GIT_DEPTH: 0
        with:
          args: -Dsonar.projectKey=p10 -Dsonar.projectName=p10

      - name: Run SonarQube Scanner
        run: sonar-scanner

  sonarqube-vulnerability-report:
    runs-on: ubuntu-latest
    needs: sonarqube-check
    steps:
      - name: Download SAST Report
        run: |
          curl -u "${{ secrets.SONAR_TOKEN }}:" "${{ secrets.SONAR_HOST_URL }}/api/issues/gitlab_sast_export?projectKey=p10&branch=${{ github.ref }}" -o gl-sast-sonar-report.json

      - name: Upload SAST Report
        uses: actions/upload-artifact@v2
        with:
          name: sast-report
          path: gl-sast-sonar-report.json
