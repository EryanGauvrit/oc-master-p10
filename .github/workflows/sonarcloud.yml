name: SonarCloud Code Analysis

permissions:
  contents: read
  actions: read

on:
  workflow_run:
    workflows:
      - "CI and Coverage Report"
    types:
      - completed

jobs:
  sonarqube:
    name: SonarCloud Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v2
        with:
          distribution: "temurin"
          java-version: "17"
      - name: Wait for Artifact Availability
        run: sleep 30
      - name: List Available Artifacts
        run: |
          curl -sH "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
          https://api.github.com/repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts | jq .

      - name: Download Backend Coverage Artifact
        run: |
          curl -L -o jacoco-report.zip -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
          https://api.github.com/repos/${{ github.repository }}/actions/artifacts/2301217797/zip
          unzip jacoco-report.zip -d back/target/site/jacoco

      - name: Download Frontend Coverage Artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-coverage-report

      - name: Run SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.organization=notmga
            -Dsonar.projectKey=NotMGA_Gerez-un-projet-collaboratif-en-int-grant-une-demarche-CI-CD
            -Dsonar.sources=.
            -Dsonar.java.binaries=back/target
            -Dsonar.jacoco.reportPaths=jacoco-report/jacoco.xml
            -Dsonar.javascript.lcov.reportPaths=frontend-coverage-report/lcov.info
            -Dsonar.host.url=https://sonarcloud.io
