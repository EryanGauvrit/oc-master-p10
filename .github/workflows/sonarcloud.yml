name: SonarCloud Code Analysis

permissions:
  contents: read
  actions: write

on:
  workflow_run:
    workflows:
      - "CI and Coverage Report" # Nom du workflow qui génère les rapports de couverture
    types:
      - completed

jobs:
  sonarqube:
    name: SonarCloud Analysis
    runs-on: ubuntu-latest

    steps:
      # Récupérer le code du repository
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # Configurer Java pour le backend - Java 17
      - name: Set up JDK 17
        uses: actions/setup-java@v2
        with:
          distribution: "temurin"
          java-version: "17"
          check-latest: true

      # Vérifier la version de Java
      - name: Verify Java Version
        run: java -version

      # Lister les artefacts disponibles
      - name: List Available Artifacts
        run: ls -al ${{ github.workspace }}

      # Télécharger les artifacts de couverture pour le backend
      - name: Download Backend Coverage Artifact
        uses: actions/download-artifact@v4
        with:
          name: jacoco-report

      # Télécharger les artifacts de couverture pour le frontend
      - name: Download Frontend Coverage Artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-coverage-report

      # Lancer l'analyse SonarCloud
      - name: Run SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.organization=notmga
            -Dsonar.projectKey=NotMGA_Gerez-un-projet-collaboratif-en-int-grant-une-demarche-CI-CD
            -Dsonar.sources=.
            -Dsonar.java.binaries=back/target
            -Dsonar.jacoco.reportPaths=jacoco-report/jacoco.xml
            -Dsonar.javascript.lcov.reportPaths=frontend-coverage-report/lcov.info
            -Dsonar.host.url=https://sonarcloud.io
